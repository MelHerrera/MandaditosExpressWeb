@model MandaditosExpress.Models.ViewModels.PagoViewModel

@{
    ViewBag.Title = "Crear pagos";
    var data = Html.HtmlConvertToJson(Model);
    @Html.Hidden("dt", data);
}

@section Styles
{
    @Styles.Render("~/Plugin/switches")
    <link href="~/Content/plugins/select2/select2.css" rel="stylesheet" />
}
<!--lo coloque aqui para que razor lo coloque de ultimo y sobreescriba la clase anterior -->
<style>
    .clients-list .tab-pane {
        position: relative;
        height: 260px;
    }
</style>

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Pagos</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="@Url.Action("Index", "HomeUser")">Inicio</a>
            </li>
            <li class="breadcrumb-item">
                <a>Catálogos</a>
            </li>
            <li class="breadcrumb-item">
                <a href="@Url.Action("Index")">Pagos</a>
            </li>
            <li class="active breadcrumb-item">
                <strong>Agregar</strong>
            </li>
        </ol>
    </div>
</div>

<div class="container">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-md-12">
                <div class="ibox ">
                    <div class="ibox-content align-items-center" data-bind="with:Pago">

                        @using (Html.BeginForm())
                        {
                            @Html.AntiForgeryToken()

                            <div class="form-horizontal">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <h4><i class="fa fa-info-circle"></i> Ingrese la información del Pago</h4>
                                    </div>
                                    <div class="col-sm-6">
                                        <h4 class="float-right"><i class="fa fa-calendar"></i> @Model.FechaDePago</h4>
                                    </div>
                                </div>

                                <hr />
                                @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                                <div class="row justify-content-center">
                                    <div class="col-md-3">
                                        <h4 class="font-weight-bold">Concepto del pago</h4>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios1" data-bind="checked:$root.Concepto, value:$root.EnvioValue">
                                            <label class="form-check-label" for="exampleRadios1">
                                                Envío
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios2" data-bind="checked:$root.Concepto, value:$root.CreditoValue">
                                            <label class="form-check-label" for="exampleRadios2">
                                                Crédito
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label name="Cliente" class="control-label font-weight-bold">Cliente</label>
                                            <select class="form-control" name="Cliente" data-bind="Select2, options:( ko.unwrap(Clientes()).length > 0 ? Clientes : [{ Nombres:'Sin registros' }] ), optionsText:'Nombres',optionsValue:'Id', value:$root.ClienteId" required></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <!--ko if:$root.EnableEnvio-->
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <p class="font-weight-bold">
                                                Lista de todos los envios del cliente seleccionado.
                                            </p>
                                            <div class="row">
                                                <div class="col-sm-6 float-right">
                                                    <div class="input-group">
                                                        <input type="text" placeholder="Búsqueda por código o descripción " class="input form-control form-control-sm" data-bind="textInput :$root.TextBusquedaEnvios">
                                                        <span class="input-group-btn">
                                                            <button type="button" class="btn btn btn-primary" data-bind="click:$root.LimpiarTextBusquedaEnvios">
                                                                <i class="fa fa-trash"></i> Limpiar
                                                            </button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="clients-list">
                                                <ul class="nav nav-tabs">
                                                    <span class="pull-right text-muted" data-bind="text:( ko.unwrap($root.EnviosFiltered()).length )">0 </span>
                                                    <span class="pull-right text-muted ml-2"> Envios</span>
                                                    <i class="fa fa-spinner fa-pulse ml-3" data-bind="visible: $root.FiltrandoEnvio"></i>
                                                </ul>
                                                <div class="tab-content">
                                                    <div id="tab-1" class="tab-pane active">
                                                        <div class="full-height-scroll">
                                                            <!--ko if:ko.unwrap($root.EnviosFiltered()).length > 0-->
                                                            <div class="table-responsive">
                                                                <table class="table table-sm table-striped table-hover">
                                                                    <thead class="bg-primary">
                                                                        <tr>
                                                                            <th>Nº</th>
                                                                            <th>Código</th>
                                                                            <th>Descripcion</th>
                                                                            <th>Fecha</th>
                                                                            <th>Monto Total</th>
                                                                            <th>Distancia</th>
                                                                            <th>Opciones</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody data-bind="foreach:ko.unwrap($root.EnviosFiltered)">
                                                                        <tr>
                                                                            <td data-bind="text:$index()+1"></td>
                                                                            <td data-bind="text:CodigoDeEnvio"></td>
                                                                            <td data-bind="text:DescripcionDeEnvio"></td>
                                                                            <td>
                                                                                <i class="fa fa-calendar"></i>
                                                                                <span data-bind="text:FechaDelEnvio"></span>
                                                                            </td>
                                                                            <td>
                                                                                <i class="fa fa-money"></i>
                                                                                <span data-bind="text:MontoTotalDelEnvio"></span>
                                                                            </td>

                                                                            <td class="fa fa-map-marker">
                                                                                <span data-bind="text: (DistanciaEntregaRecep() + ' Km')"></span>
                                                                            </td>

                                                                            <td>
                                                                                <a class="btn btn btn-primary btn-sm" data-bind="attr:{ href:'@Url.Action("/Details/","Envios")' +Id() }" target="_blank" title="Ver Detalles">
                                                                                    <i class="fa fa-info-circle"></i>
                                                                                </a>
                                                                            </td>

                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                            <!--/ko-->
                                                            <!--ko if:ko.unwrap($root.EnviosFiltered()).length <= 0-->
                                                            <div class="justify-content-center" style="text-align:center;">
                                                                <img src="~/Images/5.png" />
                                                                <div class="alert alert-warning alert-Empty mx-3" role="alert">
                                                                    Se encontraron 0 envios para mostrar.
                                                                </div>
                                                            </div>
                                                            <!--/ko-->
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <!--/ko-->
                                    <!--ko if:$root.EnableCredito-->
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <p class="font-weight-bold">
                                                Lista de todos los creditos del cliente seleccionado.
                                            </p>
                                            <div class="row">
                                                <div class="col-sm-6 float-right">
                                                    <div class="input-group">
                                                        <input type="text" placeholder="Búsqueda por código o descripción " class="input form-control form-control-sm" data-bind="textInput :$root.TextBusquedaCreditos">
                                                        <span class="input-group-btn">
                                                            <button type="button" class="btn btn btn-primary" data-bind="click:$root.LimpiarTextBusquedaCreditos">
                                                                <i class="fa fa-trash"></i> Limpiar
                                                            </button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="clients-list">
                                                <ul class="nav nav-tabs">
                                                    <span class="pull-right text-muted" data-bind="text:( ko.unwrap($root.CreditosFiltered()).length )">0 </span>
                                                    <span class="pull-right text-muted ml-2"> Creditos</span>
                                                    <i class="fa fa-spinner fa-pulse ml-3" data-bind="visible: $root.FiltrandoCred"></i>
                                                </ul>
                                                <div class="tab-content">
                                                    <div id="tab-1" class="tab-pane active">
                                                        <div class="full-height-scroll">
                                                            <!--ko if:ko.unwrap($root.CreditosFiltered()).length > 0-->
                                                            <div class="table-responsive">
                                                                <table class="table table-sm table-striped table-hover">
                                                                    <thead class="bg-primary">
                                                                        <tr>
                                                                            <th>Nº</th>
                                                                            <th>Código</th>
                                                                            <th>Descripcion</th>
                                                                            <th>Fecha de inicio</th>
                                                                            <th>Fecha de vencimiento</th>
                                                                            <th>Opciones</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody data-bind="foreach:ko.unwrap($root.CreditosFiltered)">
                                                                        <tr>
                                                                            <td data-bind="text:$index()+1"></td>
                                                                            <td data-bind="text: CodigoDelCredito"></td>
                                                                            <td data-bind="text:Descripcion"></td>
                                                                            <td>
                                                                                <i class="fa fa-calendar"></i>
                                                                                <span data-bind="text:FechaDeInicio"></span>
                                                                            </td>
                                                                            <td>
                                                                                <i class="fa fa-calendar"></i>
                                                                                <span data-bind="text:FechaDeVencimiento"></span>
                                                                            </td>

                                                                            <td>
                                                                                <a class="btn btn btn-primary btn-sm" data-bind="attr:{ href:'@Url.Action("/Details/","Creditos")' +Id() }" target="_blank" title="Ver Detalles">
                                                                                    <i class="fa fa-info-circle"></i>
                                                                                </a>
                                                                            </td>

                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                            <!--/ko-->
                                                            <!--ko if:ko.unwrap($root.CreditosFiltered()).length <= 0-->
                                                            <div class="justify-content-center" style="text-align:center;">
                                                                <img src="~/Images/5.png" />
                                                                <div class="alert alert-warning alert-Empty mx-3" role="alert">
                                                                    Se encontraron 0 creditos para mostrar.
                                                                </div>
                                                            </div>
                                                            <!--/ko-->
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <!--/ko-->
                                </div>

                                <div class="row">

                                    <div class="col-md-2">
                                        @Html.LabelFor(model => model.NumeroDePago, htmlAttributes: new { @class = "control-label " })
                                        <div class="form-group">
                                            @Html.EditorFor(model => model.NumeroDePago, new { htmlAttributes = new { @class = "form-control", data_bind = "value:NumeroDePago" } })
                                            @Html.ValidationMessageFor(model => model.NumeroDePago, "", new { @class = "text-danger" })
                                        </div>
                                    </div>

                                    <div class="col-md-2">
                                        @Html.LabelFor(model => model.MontoDelPago, htmlAttributes: new { @class = "control-label " })
                                        <div class="form-group">
                                            @Html.EditorFor(model => model.MontoDelPago, new { htmlAttributes = new { @class = "form-control-plaintext", data_bind = "value:MontoDelPago" } })
                                            @Html.ValidationMessageFor(model => model.MontoDelPago, "", new { @class = "text-danger" })
                                        </div>
                                    </div>

                                    <div class="col-md-3">
                                        @Html.LabelFor(model => model.TipoDePagoId, htmlAttributes: new { @class = "control-label" })
                                        <div class="form-group">
                                            <select class="form-control" name="TipoDePagoId" data-bind="options:TiposDePago, optionsText:'Descripcion',optionsValue:'Id', value:TipoDePagoId" required></select>
                                            @*@Html.DropDownList("TipoDePagoId", null, htmlAttributes: new { @class = "form-control" })*@
                                            @Html.ValidationMessageFor(model => model.TipoDePagoId, "", new { @class = "text-danger" })
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        @Html.LabelFor(model => model.MonedaId, htmlAttributes: new { @class = "control-label" })
                                        <div class="form-group">
                                            <select class="form-control" name="MonedaId" data-bind="options:( ko.unwrap(Monedas()).length > 0 ? Monedas() : [{ Descripcion:'Sin registros' }] ), optionsText:'Descripcion',optionsValue:'Id', value:MonedaId"></select>
                                            @Html.ValidationMessageFor(model => model.MonedaId, "", new { @class = "text-danger" })
                                        </div>
                                    </div>

                                </div>
                                <div class="row">
                                    <div class="col-md-2">
                                        @Html.LabelFor(model => model.Cambio, htmlAttributes: new { @class = "control-label" })
                                        <div class="form-group">
                                            @Html.EditorFor(model => model.Cambio, new { htmlAttributes = new { @class = "form-control", data_bind = "value:Cambio" } })
                                            @Html.ValidationMessageFor(model => model.Cambio, "", new { @class = "text-danger" })
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        @Html.LabelFor(model => model.EstadoDelPago, htmlAttributes: new { @class = "control-label col-md-2" })
                                        <div class="form-group">
                                            <div class="checkbox">
                                                @Html.EditorFor(model => model.EstadoDelPago, new { htmlAttributes = new { data_bind = "checked:EstadoDelPago" } })
                                                @Html.ValidationMessageFor(model => model.EstadoDelPago, "", new { @class = "text-danger" })
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="col-md-offset-2 col-md-10">
                                        <input type="submit" value="Create" class="btn btn-default" />
                                    </div>
                                </div>
                            </div>
                        }

                    </div>
                    <div class="ibox-footer">
                        <div class="col-md-12">
                            @Html.ActionLink(" Regresar", "Index", null, new { @class = "btn btn-primary fa fa-arrow-left" })
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/plugins/knockout")
    <script src="~/Scripts/knockout/knockout.mapping.js"></script>
    @Scripts.Render("~/plugins/switch")
    @Scripts.Render("~/plugins/notify")
    @Scripts.Render("~/plugins/sweetalert")
    <script src="~/Scripts/plugins/select2/select2.js"></script>

    <script>

        $(function () {
            var JsonData = $("#dt").val();
            $("#dt").remove();

            var indexPago = new IndexPago(JSON.parse(JsonData));

            ko.applyBindings(indexPago);
        });

        function IndexPago(pago) {
            const self = this;

            //observables
            self.Pago = ko.observable(ko.mapping.fromJS(pago));
            self.EnviosFiltered = ko.observableArray([]);
            self.CreditosFiltered = ko.observableArray([]);
            self.ClienteId = ko.observable();
            self.EnvioValue = ko.observable("Envio");
            self.CreditoValue = ko.observable("Credito");
            self.EnableCredito = ko.observable(false);
            self.EnableEnvio = ko.observable(true);
            self.FiltrandoEnvio = ko.observable(false);
            self.FiltrandoCred = ko.observable(false);
            self.TextBusquedaEnvios = ko.observable();
            self.TextBusquedaCreditos = ko.observable();
            self.Concepto = ko.observable("Envio");
            self.LimpiarTextBusquedaEnvios = function () {
                self.TextBusquedaEnvios('');
            }
            self.LimpiarTextBusquedaCreditos = function () {
                self.TextBusquedaCreditos('');
            }

            //subscripciones
            self.Concepto.subscribe(function (it) {
                if (it == self.EnvioValue()) {
                    self.EnableEnvio(true);
                    self.EnableCredito(false);
                    self.Pago().CreditoId(-1);//no seleccionar ningun credito, para cuando se haga la peticion del monto al server
                    FiltrarEnvios()
                }
                else {
                    self.EnableEnvio(false);
                    self.EnableCredito(true);
                    self.Pago().EnvioId(-1);//no seleccionar ningun envio, para cuando se haga la peticion del monto al server
                    FiltrarCreditos();
                }
            });

            self.ClienteId.subscribe(function (it) {
                if (self.Concepto() == self.EnvioValue()) {
                    FiltrarEnvios();
                }
                else {
                    FiltrarCreditos();
                }
            });

            self.Pago().EnvioId.subscribe(function (it) {
                if (it > 0) {
                    CalcularMontoEnvio();
                }
            });

            self.Pago().CreditoId.subscribe(function (it) {
                if (it > 0) {
                    CalcularMontoCredito();
                }
            });

            self.Pago().Envios.subscribe(function (items) {
                self.EnviosFiltered(items);
            });

            self.Pago().Creditos.subscribe(function (items) {
                self.CreditosFiltered(items);
            });

            self.TextBusquedaEnvios.subscribe(function (item) {
                var allEnvios = ko.unwrap(self.Pago().Envios());

                allEnvios = ko.utils.arrayFilter(allEnvios, function (it) {
                    if (it.CodigoDeEnvio().toUpperCase().indexOf(item.toUpperCase()) != -1 ||
                        it.DescripcionDeEnvio().toUpperCase().indexOf(item.toUpperCase()) != -1) {
                        return it;
                    }
                });

                self.EnviosFiltered(allEnvios);
            });

            self.TextBusquedaCreditos.subscribe(function (item) {
                var allCreditos = ko.unwrap(self.Pago().Creditos());

                allCreditos = ko.utils.arrayFilter(allCreditos, function (it) {
                    if (it.CodigoDelCredito().toUpperCase().indexOf(item.toUpperCase()) != -1 ||
                        it.Descripcion().toUpperCase().indexOf(item.toUpperCase()) != -1) {
                        return it;
                    }
                });

                self.CreditosFiltered(allCreditos);
            });

            //funciones
            function FiltrarEnvios() {
                if (self.ClienteId()) {
                    $.ajax({
                        url: "/Pagos/FiltrarEnvios",
                        type: "Get",
                        data: { ClienteId: self.ClienteId },
                        beforeSend: function () {
                            self.FiltrandoEnvio(true);
                        },
                        success: function (res) {
                            if (res.exito) {
                                //update local list
                                self.Pago().Envios([]);//primero limpiar la info
                                self.Pago().Envios(ko.mapping.fromJSON(res.data));
                            }
                        },
                        error: function (e) {
                            $.notify({
                                icon: 'fa fa-exclamation-circle',
                                message: "Ha ocurrido un error procesando tu solicitd. Internal error server"
                            });
                        },
                        complete: function () {
                            self.FiltrandoEnvio(false);
                        }
                    });
                }
                else
                    InvalidClientError();
            }

            function FiltrarCreditos() {
                if (self.ClienteId()) {
                    $.ajax({
                        url: "/Pagos/FiltrarCreditos",
                        type: "Get",
                        data: { ClienteId: self.ClienteId },
                        beforeSend: function () {
                            self.FiltrandoCred(true);
                        },
                        success: function (res) {
                            if (res.exito) {
                                //update local list
                                self.Pago().Creditos([]);//primero limpiar la info
                                self.Pago().Creditos(ko.mapping.fromJSON(res.data));
                            }
                        },
                        error: function (e) {
                            $.notify({
                                icon: 'fa fa-exclamation-circle',
                                message: "Ha ocurrido un error procesando tu solicitd. Internal error server"
                            });
                        },
                        complete: function () {
                            self.FiltrandoCred(false);
                        }
                    });
                }
                else
                    InvalidClientError();
            }

            function CalcularMontoEnvio() {
                $.ajax({
                    url: "/Pagos/CalcularMontoEnvio",
                    type: "Get",
                    data: { EnvioId: self.Pago().EnvioId() },
                    beforeSend: function () {
                        //self.FiltrandoCred(true);
                    },
                    success: function (res) {
                        if (res.exito) {
                            //update local list
                            self.Pago().MontoDelPago(res.data);
                        }
                    },
                    error: function (e) {
                        $.notify({
                            icon: 'fa fa-exclamation-circle',
                            message: "Ha ocurrido un error procesando tu solicitd. Internal error server"
                        });
                    },
                    complete: function () {
                        // self.FiltrandoCred(false);
                    }
                });
            }
            function CalcularMontoCredito() {
                $.ajax({
                    url: "/Pagos/CalcularMontoCredito",
                    type: "Get",
                    data: { CreditoId: self.Pago().CreditoId() },
                    beforeSend: function () {
                        //self.FiltrandoCred(true);
                    },
                    success: function (res) {
                        if (res.exito) {
                            //update local list
                            self.Pago().MontoDelPago(res.data);
                        }
                    },
                    error: function (e) {
                        $.notify({
                            icon: 'fa fa-exclamation-circle',
                            message: "Ha ocurrido un error procesando tu solicitd. Internal error server"
                        });
                    },
                    complete: function () {
                        // self.FiltrandoCred(false);
                    }
                });
            }

            function InvalidClientError() {
                Swal.fire({
                    icon: 'error',
                    text: 'No se ha seleccionado un cliente válido'
                })
            }
        }

    </script>
}