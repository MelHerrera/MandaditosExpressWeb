@model MandaditosExpress.Models.ViewModels.CotizacionViewModel

@{
    ViewBag.Title = "Cotización";
    Layout = null;
}

@Styles.Render("~/Content/site/cotizacion")
@Styles.Render("~/Content/bootstrap")
@Styles.Render("~/font-awesome/css")

<body>
    <div class="main">
        <section class="signup">
            <div class="container">
                <div class="register">
                    <div class="signup-content" data-bind="with:Cotizacion">
                        <div class="signup-form">
                            <h4>Estimada(o) @ViewBag.Cliente Cotizá nuestros precios</h4>

                            @using (Html.BeginForm())
                            {
                                @Html.AntiForgeryToken()

                                <div class="form-horizontal">

                                    <hr />
                                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                                    <div class="form-group row">
                                        <div class="col-auto">
                                            @Html.LabelFor(model => model.TipoDeServicioId, "TipoDeServicioId", htmlAttributes: new { @class = "control-label" })
                                        </div>
                                        <div class="col-auto">
                                            @*@Html.DropDownList("TipoDeServicioId", null, htmlAttributes: new { @class = "form-control" })*@
                                            <select class="form-control" data-bind="options: TiposDeServicios, optionsText: 'DescripcionTipoDeServicio', optionsValue: 'Id',value:TipoDeServicioId"></select>
                                            @Html.ValidationMessageFor(model => model.TipoDeServicioId, "", new { @class = "text-danger" })
                                        </div>
                                    </div>

                                    <div class="form-row align-items-center">
                                        <div class="col-auto">
                                            @Html.EditorFor(model => model.DescripcionDeCotizacion, new { htmlAttributes = new { @class = "form-control mb-2", @placeholder = "Descripcion", data_bind = "value:DescripcionDeCotizacion" } })
                                            @Html.ValidationMessageFor(model => model.DescripcionDeCotizacion, "", new { @class = "text-danger" })
                                        </div>
                                        <div class="col-auto col-md-5">
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text"><i class="fa fa-sort"></i></div>
                                                    @Html.EditorFor(model => model.MontoDeDinero, new { htmlAttributes = new { @class = "form-control", @type = "number", @min = 100, @placeholder = "Monto de Dinero", data_bind = "value:MontoDeDinero,enable:$root.MostrarMonto" } })
                                                </div>
                                            </div>
                                            @Html.ValidationMessageFor(model => model.MontoDeDinero, "", new { @class = "text-danger" })
                                        </div>
                                    </div>

                                    <div class="form-row align-items-center">
                                        <div class="col">
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text bg-white"><i class="fa fa-dot-circle-o"></i></div>
                                                </div>
                                                @Html.EditorFor(model => model.DireccionDeOrigen, new { htmlAttributes = new { @class = "form-control", @placeholder = "Direccion de Origen", data_bind = "value:DireccionDeOrigen,enable:$root.MostrarDirecciones" } })
                                                @Html.ValidationMessageFor(model => model.DireccionDeOrigen, "", new { @class = "text-danger" })
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row align-items-center">
                                        <div class="col">
                                            <div class="input-group mb-2">
                                                <div class="input-group-prepend">
                                                    <div class="input-group-text bg-white"><i class="fa fa-map-marker"></i></div>
                                                </div>
                                                @Html.EditorFor(model => model.DireccionDestino, new { htmlAttributes = new { @class = "form-control", @placeholder = "Direccion Destino", data_bind = "value:DireccionDestino,enable:$root.MostrarDirecciones" } })
                                            </div>
                                            @Html.ValidationMessageFor(model => model.DireccionDestino, "", new { @class = "text-danger" })
                                            <small class="form-text text-muted font-weight-bold mb-2">
                                                Distancia: <input data-bind="value:DistanciaOrigenDestino" />
                                            </small>
                                        </div>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="EsEspecial" name="EsEspecial" data-bind="checked:EsEspecial">
                                        <label class="form-check-label" for="EsEspecial">
                                            ¿Es Especial?
                                        </label>
                                        @Html.ValidationMessageFor(model => model.EsEspecial, "", new { @class = "text-danger" })
                                    </div>

                                    <div class="form-group m-5">
                                        <div class="col-md-offset-2 col-auto">
                                            <button data-bind="click:$root.RealizarCotizacion,attr:{href:'@Url.Action("Create")'}" class="btn btn-success">
                                                Realizar Cotización
                                                <i class="fa fa-spinner fa-spin fa-lg fa-fw" data-bind="visible:$root.SendingData"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="signup-image">
                            <div class="card" style="width: 18rem;">
                                <h5 class="badge badge-danger text-white align-self-end p-1" style="position:absolute">Validez: @Model.FechaDeValidez</h5>
                                <img class="card-img-top border-bottom" src="~/Images/card-header.jpg" alt="Card image cap">
                                <div class="card-body">
                                    <h5 class="card-title badge badge-success p-2">Monto Total</h5>

                                    <div class="row">
                                        <div class="col align-items-center">
                                            <div class="mb-1">
                                                <h2 class="font-bold no-margins" style="color:black;">
                                                    C$ <span data-bind="text:MontoTotal" class="text-danger"></span>
                                                </h2>
                                                <small class="text-black-50">Precios ya incluyen IVA</small>
                                            </div>
                                        </div>
                                        <div class="col align-items-center"><span id="sparkline" class="m-0"></span></div>
                                    </div>

                                    <div data-bind="with:$root.MostrarOpciones">
                                        <input type="button" class="btn-success btn" value="Solicitar Envio" data-bind="click:$root.RealizarEnvio" />
                                        <a class="btn btn-default border-success" data-bind="click:$root.GuardarCotizacion"><i class="fa fa-clock-o"></i> Guardar</a>
                                    </div>
                                    <small><i class="fa fa-calendar"></i> @Model.FechaDeLaCotizacion</small>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</body>

<pre>
<code data-bind="html: JSON.stringify(ko.toJS($root), null, 3)"></code>
</pre>

@Scripts.Render("~/bundles/jquery")
@Scripts.Render("~/bundles/jqueryval")
@Scripts.Render("~/plugins/knockout")
@Scripts.Render("~/plugins/sparkline")
@Scripts.Render("~/plugins/moment")
@Scripts.Render("~/plugins/sweetalert")
@Scripts.Render("~/plugins/notify")

<script type="text/javascript">

    $(function () {
        InicializarGrafico();
    });

                    function TipoDeServicioViewModel(tiposDeServicio) {
                        const self = this;
                        self.Id = ko.observable(tiposDeServicio.Id);
                        self.DescripcionTipoDeServicio = ko.observable(tiposDeServicio.DescripcionTipoDeServicio);
                        self.EstadoTipoDeServicio = ko.observable(tiposDeServicio.EstadoTipoDeServicio);
                    }


                    function CotizacionViewModel(cotizacion) {
                        const self = this;
                        self.Id = ko.observable(cotizacion.Id || -1);
                        self.DescripcionDeCotizacion = ko.observable(cotizacion.DescripcionDeCotizacion || "");
                        self.FechaDeLaCotizacion = ko.observable(cotizacion.FechaDeLaCotizacion || "");
                        self.FechaDeValidez = ko.observable(cotizacion.FechaDeValidez || "");
                        self.DireccionDeOrigen = ko.observable(cotizacion.DireccionDeOrigen || "");
                        self.DireccionDestino = ko.observable(cotizacion.DireccionDestino || "");
                        self.DistanciaOrigenDestino = ko.observable(cotizacion.DistanciaOrigenDestino || 0);
                        self.EsEspecial = ko.observable(cotizacion.EsEspecial || false);
                        self.MontoTotal = ko.observable(cotizacion.MontoTotal || 0);
                        self.ClienteId = ko.observable(cotizacion.ClienteId || -1);
                        self.TipoDeServicioId = ko.observable(cotizacion.TipoDeServicioId || -1);
                        self.MontoDeDinero = ko.observable(cotizacion.MontoDeDinero || 0);
                        self.GestionBancariaId = ko.observable(cotizacion.GestionBancariaId || -1);
                        self.TiposDeServicios = ko.observableArray(ko.utils.arrayMap(cotizacion.TiposDeServicios, function (item) { return new TipoDeServicioViewModel(item) }));
                    }

                    function IndexCotizacionViewModel(initialData) {
                        const self = this;
                        self.Cotizacion = ko.observable(new CotizacionViewModel(initialData));
                        self.MostrarMonto = ko.observable(false);
                        self.MostrarDirecciones = ko.observable(true);
                        self.TipoDeServicioIdAnterior = ko.observable();
                        self.SendingData = ko.observable(false);

                        self.RealizarEnvio = function () {
                            alert("enviando");
                        }
                        self.GuardarCotizacion = function () {
                            alert("Guardando la cotizacion");
                        }
                        self.RealizarCotizacion = function (data,event) {
                            event.preventDefault();

                            let frm = $('form');

                            if (frm.valid()) {

                                let token = $('form input[name="__RequestVerificationToken"]').val();

                                $.ajax(
                                    {
                                        url: $(event.currentTarget).attr("href"),
                                        type: "Post",
                                        data: { __RequestVerificationToken: token, cotizacion: ko.toJS(data) },
                                        beforeSend: function () {
                                            self.SendingData(true);
                                        },
                                        success: function (result) {
                                            self.Cotizacion().MontoTotal(result.MontoTotal);
                                            InicializarGrafico();
                                            $.notify({
                                                icon: 'fa fa-check-circle',
                                                message: "Cotizacion Realizada Exitosamente"
                                            });
                                        },
                                        error: function (e) {
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Oops...',
                                                text: 'Algo salio mal, disculpanos!',
                                                footer: 'Consulta con el administrador del sistema.'
                                            })
                                        },
                                        complete: function () {
                                            self.SendingData(false);
                                        }
                                    }
                                );
                            }
                        }

                        //computables
                        self.MostrarOpciones = ko.observable(false);
                        //subscripciones

                        //subscripcion al TipoDeServicioId despues que su valor cambie
                        self.Cotizacion().TipoDeServicioId.subscribe(function (nuevo) {
                            if (nuevo != self.TipoDeServicioIdAnterior) {

                                if (nuevo == self.Cotizacion().GestionBancariaId()) {
                                    self.MostrarMonto(true);
                                    self.MostrarDirecciones(false);
                                    self.Cotizacion().DireccionDeOrigen("").DireccionDestino("").DistanciaOrigenDestino(0);//si no estan activas las direcciones resetearles el valor para que no se envien al servidor con el valor viejo
                                }
                                else {
                                    self.MostrarMonto(false);
                                    self.Cotizacion().MontoDeDinero(0);
                                    self.MostrarDirecciones(true);
                                }

                               self.Cotizacion().MontoTotal(0);//siempre que cambie el tipo de servicio se tiene que volver a recalcular la cotizacion
                            }
                        });

                          //subscripcion al TipoDeServicioId antes que su valor cambie
                        self.Cotizacion().TipoDeServicioId.subscribe(function (viejo) {
                            self.TipoDeServicioIdAnterior(viejo);
                        }, null,"beforeChange");

                        self.Cotizacion().MontoTotal.subscribe(function (nuevo) {
                            self.MostrarOpciones(nuevo>0);
                        });
                    };

                                        var data = @Html.HtmlConvertToJson(Model);
                                        ////controller return the serialized json date in other ISO format so we have format the date
                                        data.FechaDeLaCotizacion = formatDate(data.FechaDeLaCotizacion);
                                        data.FechaDeValidez = formatDate(data.FechaDeValidez);
                                        ko.applyBindings(new IndexCotizacionViewModel(data));

    function InicializarGrafico() {

        var values = [5, 6, 7, 5, 13, 7, 6, 7, 6, 4, 7];

        var range_map = $.range_map({
            '7:': 'green',
        });

        // Draw a sparkline for the #sparkline element
        $('#sparkline').sparkline(values, {
            type: "bar",
            barWidth: 10,
            height: 80,
            barColor: '#0083CD',
            colorMap: range_map,
            chartRangeMax: 12
        });
                    }

                                        function formatDate(dataToFormat) {
                                            let formatDate = "YYYY-MM-DD, h:mm:ss a";
                                            return moment(dataToFormat).format(formatDate)
                                        }

</script>
